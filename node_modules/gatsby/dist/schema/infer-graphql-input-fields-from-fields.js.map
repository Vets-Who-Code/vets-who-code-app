{"version":3,"sources":["../../src/schema/infer-graphql-input-fields-from-fields.js"],"names":["inferInputObjectStructureFromFields","require","GraphQLInputObjectType","GraphQLBoolean","GraphQLString","GraphQLFloat","GraphQLInt","GraphQLID","GraphQLList","GraphQLEnumType","GraphQLNonNull","GraphQLScalarType","GraphQLObjectType","GraphQLInterfaceType","GraphQLUnionType","_","report","createTypeName","createKey","makeNullable","type","ofType","convertToInputType","typeMap","has","nextTypeMap","Set","Array","from","concat","fields","transform","getFields","out","fieldConfig","key","Object","keys","length","name","innerType","message","verbose","scalarFilterMap","Int","eq","ne","Float","ID","String","regex","glob","Boolean","convertToInputFilter","prefix","upperFirst","innerFilter","innerFields","in","extractFieldNamesFromInputField","accu","push","each","typeName","inferredFields","sort","inputType","inputFilter"],"mappings":"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","file":"infer-graphql-input-fields-from-fields.js","sourcesContent":["// @flow\n\nconst {\n  GraphQLInputObjectType,\n  GraphQLBoolean,\n  GraphQLString,\n  GraphQLFloat,\n  GraphQLInt,\n  GraphQLID,\n  GraphQLList,\n  GraphQLEnumType,\n  GraphQLNonNull,\n  GraphQLScalarType,\n  GraphQLObjectType,\n  GraphQLInterfaceType,\n  GraphQLUnionType,\n} = require(`graphql`)\n\nimport type { GraphQLInputType, GraphQLType } from \"graphql\"\n\nconst _ = require(`lodash`)\nconst report = require(`gatsby-cli/lib/reporter`)\nconst createTypeName = require(`./create-type-name`)\nconst createKey = require(`./create-key`)\n\ntype GraphQLNullableInputType<T> =\n  | GraphQLScalarType\n  | GraphQLEnumType\n  | GraphQLInputObjectType\n  | GraphQLList<T>\n\nfunction makeNullable(type: GraphQLInputType): GraphQLNullableInputType<any> {\n  if (type instanceof GraphQLNonNull) {\n    return type.ofType\n  }\n  return type\n}\n\nfunction convertToInputType(\n  type: GraphQLType,\n  typeMap: Set\n): ?GraphQLInputType {\n  // track types already processed in current tree, to avoid infinite recursion\n  if (typeMap.has(type)) {\n    return null\n  }\n  const nextTypeMap = new Set(Array.from(typeMap).concat([type]))\n\n  if (type instanceof GraphQLScalarType || type instanceof GraphQLEnumType) {\n    return type\n  } else if (type instanceof GraphQLObjectType) {\n    const fields = _.transform(type.getFields(), (out, fieldConfig, key) => {\n      const type = convertToInputType(fieldConfig.type, nextTypeMap)\n      if (type) out[key] = { type }\n    })\n    if (Object.keys(fields).length === 0) {\n      return null\n    }\n    return new GraphQLInputObjectType({\n      name: createTypeName(`${type.name}InputObject`),\n      fields,\n    })\n  } else if (type instanceof GraphQLList) {\n    let innerType = convertToInputType(type.ofType, nextTypeMap)\n    return innerType ? new GraphQLList(makeNullable(innerType)) : null\n  } else if (type instanceof GraphQLNonNull) {\n    let innerType = convertToInputType(type.ofType, nextTypeMap)\n    return innerType ? new GraphQLNonNull(makeNullable(innerType)) : null\n  } else {\n    let message = type ? `for type: ${type.name}` : ``\n    if (type instanceof GraphQLInterfaceType) {\n      message = `GraphQLInterfaceType not yet implemented ${message}`\n    } else if (type instanceof GraphQLUnionType) {\n      message = `GraphQLUnionType not yet implemented ${message}`\n    } else {\n      message = `Invalid input type ${message}`\n    }\n    report.verbose(message)\n  }\n\n  return null\n}\n\nconst scalarFilterMap = {\n  Int: {\n    eq: { type: GraphQLInt },\n    ne: { type: GraphQLInt },\n  },\n  Float: {\n    eq: { type: GraphQLFloat },\n    ne: { type: GraphQLFloat },\n  },\n  ID: {\n    eq: { type: GraphQLID },\n    ne: { type: GraphQLID },\n  },\n  String: {\n    eq: { type: GraphQLString },\n    ne: { type: GraphQLString },\n    regex: { type: GraphQLString },\n    glob: { type: GraphQLString },\n  },\n  Boolean: {\n    eq: { type: GraphQLBoolean },\n    ne: { type: GraphQLBoolean },\n  },\n}\n\nfunction convertToInputFilter(\n  prefix: string,\n  type: GraphQLInputType\n): ?GraphQLInputObjectType {\n  if (type instanceof GraphQLScalarType) {\n    const name = type.name\n    const fields = scalarFilterMap[name]\n\n    if (fields == null) return null\n    return new GraphQLInputObjectType({\n      name: createTypeName(`${prefix}Query${name}`),\n      fields: fields,\n    })\n  } else if (type instanceof GraphQLInputObjectType) {\n    return new GraphQLInputObjectType({\n      name: createTypeName(`${prefix}{type.name}`),\n      fields: _.transform(type.getFields(), (out, fieldConfig, key) => {\n        const type = convertToInputFilter(\n          `${prefix}${_.upperFirst(key)}`,\n          fieldConfig.type\n        )\n        if (type) out[key] = { type }\n      }),\n    })\n  } else if (type instanceof GraphQLList) {\n    const innerType = type.ofType\n    const innerFilter = convertToInputFilter(`${prefix}ListElem`, innerType)\n    const innerFields = innerFilter ? innerFilter.getFields() : {}\n\n    return new GraphQLInputObjectType({\n      name: createTypeName(`${prefix}QueryList`),\n      fields: {\n        ...innerFields,\n        in: { type: new GraphQLList(innerType) },\n      },\n    })\n  } else if (type instanceof GraphQLNonNull) {\n    return convertToInputFilter(prefix, type.ofType)\n  }\n\n  return null\n}\n\nfunction extractFieldNamesFromInputField(\n  prefix: string,\n  type: GraphQLInputType,\n  accu: string[]\n) {\n  if (type instanceof GraphQLScalarType || type instanceof GraphQLList) {\n    accu.push(prefix)\n  } else if (type instanceof GraphQLInputObjectType) {\n    _.each(type.getFields(), (fieldConfig, key) => {\n      extractFieldNamesFromInputField(\n        `${prefix}___${key}`,\n        fieldConfig.type,\n        accu\n      )\n    })\n  } else if (type instanceof GraphQLNonNull) {\n    extractFieldNamesFromInputField(prefix, type.ofType, accu)\n  }\n}\n\n// convert output fields to output fields and a list of fields to sort on\nexport function inferInputObjectStructureFromFields({\n  fields,\n  typeName = ``,\n}: any) {\n  const inferredFields = {}\n  const sort = []\n\n  _.each(fields, (fieldConfig, key) => {\n    const inputType = convertToInputType(fieldConfig.type, new Set())\n    const inputFilter =\n      inputType && convertToInputFilter(_.upperFirst(key), inputType)\n\n    if (!inputFilter) return\n\n    inferredFields[createKey(key)] = { type: inputFilter }\n\n    // Add sorting (but only to the top level).\n    if (typeName) {\n      extractFieldNamesFromInputField(key, inputType, sort)\n    }\n  })\n\n  return { inferredFields, sort }\n}\n"]}