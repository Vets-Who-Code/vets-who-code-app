{"version":3,"sources":["../../../src/internal-plugins/internal-data-bridge/gatsby-node.js"],"names":["crypto","require","moment","chokidar","systemPath","_","emitter","boundActionCreators","getNode","transformPackageJson","json","transformDeps","entries","deps","map","name","version","pick","dependencies","devDependencies","peerDependencies","optionalDependecies","bundledDependecies","exports","sourceNodes","store","createNode","state","getState","program","flattenedPlugins","page","path","id","createPageId","parent","children","internal","type","contentDigest","createHash","update","JSON","stringify","digest","forEach","plugin","pluginFilepath","resolve","packageJson","buildTime","subtract","process","uptime","toJSON","createGatsbyConfigNode","config","configCopy","plugins","node","siteMetadata","port","host","pathToGatsbyConfig","join","directory","watch","on","cache","onCreatePage","nodeId","action","payload","deleteNode"],"mappings":"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","file":"gatsby-node.js","sourcesContent":["const crypto = require(`crypto`)\nconst moment = require(`moment`)\nconst chokidar = require(`chokidar`)\nconst systemPath = require(`path`)\nconst _ = require(`lodash`)\n\nconst { emitter } = require(`../../redux`)\nconst { boundActionCreators } = require(`../../redux/actions`)\nconst { getNode } = require(`../../redux`)\n\nfunction transformPackageJson(json) {\n  const transformDeps = deps =>\n    _.entries(deps).map(([name, version]) => {\n      return {\n        name,\n        version,\n      }\n    })\n\n  json = _.pick(json, [\n    `name`,\n    `description`,\n    `version`,\n    `main`,\n    `keywords`,\n    `author`,\n    `license`,\n    `dependencies`,\n    `devDependencies`,\n    `peerDependencies`,\n    `optionalDependecies`,\n    `bundledDependecies`,\n  ])\n  json.dependencies = transformDeps(json.dependencies)\n  json.devDependencies = transformDeps(json.devDependencies)\n  json.peerDependencies = transformDeps(json.peerDependencies)\n  json.optionalDependecies = transformDeps(json.optionalDependecies)\n  json.bundledDependecies = transformDeps(json.bundledDependecies)\n\n  return json\n}\n\nexports.sourceNodes = ({ boundActionCreators, store }) => {\n  const { createNode } = boundActionCreators\n  const state = store.getState()\n  const { program } = state\n  const { flattenedPlugins } = state\n\n  // Add our default development page since we know it's going to\n  // exist and we need a node to exist so its query works :-)\n  const page = { path: `/dev-404-page/` }\n  createNode({\n    ...page,\n    id: createPageId(page.path),\n    parent: `SOURCE`,\n    children: [],\n    internal: {\n      type: `SitePage`,\n      contentDigest: crypto\n        .createHash(`md5`)\n        .update(JSON.stringify(page))\n        .digest(`hex`),\n    },\n  })\n\n  flattenedPlugins.forEach(plugin => {\n    plugin.pluginFilepath = plugin.resolve\n    createNode({\n      ...plugin,\n      packageJson: transformPackageJson(\n        require(`${plugin.resolve}/package.json`)\n      ),\n      parent: `SOURCE`,\n      children: [],\n      internal: {\n        contentDigest: crypto\n          .createHash(`md5`)\n          .update(JSON.stringify(plugin))\n          .digest(`hex`),\n        type: `SitePlugin`,\n      },\n    })\n  })\n\n  // Add site node.\n  const buildTime = moment()\n    .subtract(process.uptime(), `seconds`)\n    .toJSON()\n\n  const createGatsbyConfigNode = (config = {}) => {\n    // Delete plugins from the config as we add plugins above.\n    const configCopy = { ...config }\n    delete configCopy.plugins\n    const node = {\n      siteMetadata: {\n        ...configCopy.siteMetadata,\n      },\n      port: state.program.port,\n      host: state.program.host,\n      ...configCopy,\n      buildTime,\n    }\n    createNode({\n      ...node,\n      id: `Site`,\n      parent: `SOURCE`,\n      children: [],\n      internal: {\n        contentDigest: crypto\n          .createHash(`md5`)\n          .update(JSON.stringify(node))\n          .digest(`hex`),\n        type: `Site`,\n      },\n    })\n  }\n\n  createGatsbyConfigNode(state.config)\n\n  const pathToGatsbyConfig = systemPath.join(\n    program.directory,\n    `gatsby-config.js`\n  )\n  chokidar.watch(pathToGatsbyConfig).on(`change`, () => {\n    // Delete require cache so we can reload the module.\n    delete require.cache[require.resolve(pathToGatsbyConfig)]\n    const config = require(pathToGatsbyConfig)\n    createGatsbyConfigNode(config)\n  })\n}\n\nconst createPageId = path => `SitePage ${path}`\n\nexports.onCreatePage = ({ page, boundActionCreators }) => {\n  const { createNode } = boundActionCreators\n\n  // Add page.\n  createNode({\n    ...page,\n    id: createPageId(page.path),\n    parent: `SOURCE`,\n    children: [],\n    internal: {\n      type: `SitePage`,\n      contentDigest: crypto\n        .createHash(`md5`)\n        .update(JSON.stringify(page))\n        .digest(`hex`),\n    },\n  })\n}\n\n// Listen for DELETE_PAGE and delete page nodes.\nemitter.on(`DELETE_PAGE`, action => {\n  const nodeId = createPageId(action.payload.path)\n  const node = getNode(nodeId)\n  boundActionCreators.deleteNode(nodeId, node)\n})\n"]}