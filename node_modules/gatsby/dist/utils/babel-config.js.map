{"version":3,"sources":["../../src/utils/babel-config.js"],"names":["resolvePlugin","pluginName","directory","type","Array","isArray","gatsbyPath","resolve","__dirname","plugin","name","startsWith","pluginInvariantMessage","normalizeConfig","config","normalizedConfig","presets","plugins","normalize","value","normalized","forEach","push","preset","Object","assign","findBabelrc","babelrc","readFileSync","join","parse","error","code","findBabelPackage","packageJson","require","babel","module","exports","program","stage","loose","uglify","modules","targets","browsers","browserslist","exclude","unshift","hasOwnProperty","cacheDirectory","modifiedConfig","length","merge","merged","defaultsDeep","babelConfig"],"mappings":"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","file":"babel-config.js","sourcesContent":["/* @flow */\nimport resolve from \"babel-core/lib/helpers/resolve\"\nimport fs from \"fs\"\nimport path from \"path\"\nimport json5 from \"json5\"\nimport _ from \"lodash\"\nimport invariant from \"invariant\"\nimport apiRunnerNode from \"./api-runner-node\"\n\n// TODO update this to store Babelrc config in Redux store.\n\n/**\n * Uses babel-core helpers to resolve the plugin given its name. It\n * resolves plugins in the following order:\n *\n * 1. Adding babel-type prefix and checking user's local modules\n * 2. Adding babel-type prefix and checking Gatsby's modules\n * 3. Checking users's modules without prefix\n * 4. Checking Gatsby's modules without prefix\n *\n */\nfunction resolvePlugin(pluginName, directory, type) {\n  // When a plugin is specified with options in babelrc, the pluginName contains\n  // the array with [name, options]. In that case we extract the name.\n  pluginName = Array.isArray(pluginName) ? pluginName[0] : pluginName\n\n  const gatsbyPath = path.resolve(__dirname, `..`, `..`)\n  const plugin =\n    resolve(`babel-${type}-${pluginName}`, directory) ||\n    resolve(`babel-${type}-${pluginName}`, gatsbyPath) ||\n    resolve(pluginName, directory) ||\n    resolve(pluginName, gatsbyPath)\n\n  const name = _.startsWith(pluginName, `babel`)\n    ? pluginName\n    : `babel-${type}-${pluginName}`\n  const pluginInvariantMessage = `\n  You are trying to use a Babel plugin or preset which Gatsby cannot find: ${pluginName}\n\n  You can install it using \"npm install --save ${name}\".\n\n  You can use any of the Gatsby provided plugins without installing them:\n    - babel-plugin-add-module-exports\n    - babel-plugin-transform-object-assign\n    - babel-preset-es2015\n    - babel-preset-react\n    - babel-preset-stage-0\n  `\n\n  invariant(plugin !== null, pluginInvariantMessage)\n  return plugin\n}\n\n/**\n * Normalizes a Babel config object to include only absolute paths.\n * This way babel-loader will correctly resolve Babel plugins\n * regardless of where they are located.\n */\nfunction normalizeConfig(config, directory) {\n  const normalizedConfig = {\n    presets: [],\n    plugins: [],\n  }\n\n  const presets = config.presets || []\n  const plugins = config.plugins || []\n\n  const normalize = (value, name) => {\n    let normalized\n\n    if (_.isArray(value)) {\n      normalized = [resolvePlugin(value[0], directory, name), value[1]]\n    } else {\n      normalized = resolvePlugin(value, directory, name)\n    }\n\n    return normalized\n  }\n\n  presets.forEach(preset =>\n    normalizedConfig.presets.push(normalize(preset, `preset`))\n  )\n  plugins.forEach(plugin =>\n    normalizedConfig.plugins.push(normalize(plugin, `plugin`))\n  )\n\n  return Object.assign({}, config, normalizedConfig)\n}\n\n/**\n * Locates a .babelrc in the Gatsby site root directory. Parses it using\n * json5 (what Babel uses). It throws an error if the users's .babelrc is\n * not parseable.\n */\nfunction findBabelrc(directory) {\n  try {\n    const babelrc = fs.readFileSync(path.join(directory, `.babelrc`), `utf-8`)\n    return json5.parse(babelrc)\n  } catch (error) {\n    if (error.code === `ENOENT`) {\n      return null\n    } else {\n      throw error\n    }\n  }\n}\n\n/**\n * Reads the user's package.json and returns the \"babel\" section. It will\n * return undefined when the \"babel\" section does not exist.\n */\nfunction findBabelPackage(directory) {\n  try {\n    // $FlowIssue - https://github.com/facebook/flow/issues/1975\n    const packageJson = require(path.join(directory, `package.json`))\n    return packageJson.babel\n  } catch (error) {\n    if (error.code === `MODULE_NOT_FOUND`) {\n      return null\n    } else {\n      throw error\n    }\n  }\n}\n\n/**\n * Returns a normalized Babel config to use with babel-loader. All of\n * the paths will be absolute so that Babel behaves as expected.\n */\nmodule.exports = async function babelConfig(program, stage) {\n  const { directory } = program\n\n  let babelrc = findBabelrc(directory) || findBabelPackage(directory)\n\n  // If user doesn't have a custom babelrc, add defaults.\n  if (!babelrc) {\n    babelrc = {}\n  }\n  if (!babelrc.plugins) {\n    babelrc.plugins = []\n  }\n  if (!babelrc.presets) {\n    babelrc.presets = []\n  }\n\n  // Add default plugins and presets.\n  ;[\n    [\n      require.resolve(`babel-preset-env`),\n      {\n        loose: true,\n        uglify: true,\n        modules: `commonjs`,\n        targets: {\n          browsers: program.browserslist,\n        },\n        exclude: [`transform-regenerator`, `transform-es2015-typeof-symbol`],\n      },\n    ],\n    `stage-0`,\n    `react`,\n  ].forEach(preset => {\n    babelrc.presets.push(preset)\n  })\n  ;[`add-module-exports`, `transform-object-assign`].forEach(plugin => {\n    babelrc.plugins.push(plugin)\n  })\n\n  if (stage === `develop`) {\n    babelrc.plugins.unshift(`transform-react-jsx-source`)\n    babelrc.plugins.unshift(`react-hot-loader/babel`)\n  }\n\n  babelrc.plugins.unshift(require.resolve(`./babel-plugin-extract-graphql`))\n\n  if (!babelrc.hasOwnProperty(`cacheDirectory`)) {\n    babelrc.cacheDirectory = true\n  }\n\n  const normalizedConfig = normalizeConfig(babelrc, directory)\n  let modifiedConfig = await apiRunnerNode(`modifyBabelrc`, {\n    babelrc: normalizedConfig,\n  })\n  if (modifiedConfig.length > 0) {\n    modifiedConfig = _.merge({}, ...modifiedConfig)\n    // Otherwise this means no plugin changed the babel config.\n  } else {\n    modifiedConfig = {}\n  }\n\n  // Merge all together.\n  const merged = _.defaultsDeep(modifiedConfig, normalizedConfig)\n  return merged\n}\n"]}