{"version":3,"sources":["../../src/bootstrap/page-hot-reloader.js"],"names":["_","require","emitter","store","apiRunnerNode","boundActionCreators","deletePage","deleteComponentsDependencies","pagesDirty","graphql","on","action","payload","internal","type","debouncedCreatePages","runCreatePages","plugins","getState","statefulPlugins","filter","gatsbyNode","p","resolve","createPagesStatefully","e","map","id","timestamp","Date","toJSON","traceId","waitForCascadingActions","pages","includes","pluginCreatorId","updatedAt","forEach","page","path","emit","debounce","module","exports","graphqlRunner"],"mappings":";;;;;;;;;;;;AAAA,IAAMA,IAAIC,QAAS,QAAT,CAAV;;eAE2BA,QAAS,UAAT,C;IAAnBC,O,YAAAA,O;IAASC,K,YAAAA,K;;AACjB,IAAMC,gBAAgBH,QAAS,0BAAT,CAAtB;;gBACgCA,QAAS,kBAAT,C;IAAxBI,mB,aAAAA,mB;;IACAC,U,GAA6CD,mB,CAA7CC,U;IAAYC,4B,GAAiCF,mB,CAAjCE,4B;;;AAEpB,IAAIC,aAAa,KAAjB;AACA,IAAIC,gBAAJ;;AAEAP,QAAQQ,EAAR,CAAY,aAAZ,EAA0B,kBAAU;AAClC,MAAIC,OAAOC,OAAP,CAAeC,QAAf,CAAwBC,IAAxB,KAAkC,UAAtC,EAAiD;AAC/CN,iBAAa,IAAb;AACD;AACF,CAJD;AAKAN,QAAQQ,EAAR,CAAY,aAAZ,EAA0B,kBAAU;AAClCF,eAAa,IAAb;AACAO;AACD,CAHD;;AAKAb,QAAQQ,EAAR,CAAY,yBAAZ,EAAsC,YAAM;AAC1C,MAAIF,UAAJ,EAAgB;AACdO;AACD;AACF,CAJD;;AAMA,IAAMC;AAAA,sFAAiB;AAAA;AAAA;AAAA;AAAA;AAAA;AACrBR,yBAAa,KAAb;AACMS,mBAFe,GAELd,MAAMe,QAAN,GAAiBD,OAFZ;AAGrB;AACA;;AACME,2BALe,GAKGF,QACrBG,MADqB,CACd,aAAK;AACX,kBAAI;AACF,oBAAMC,aAAapB,QAAS,GAAEqB,EAAEC,OAAQ,cAArB,CAAnB;AACA,oBAAIF,WAAWG,qBAAf,EAAsC;AACpC,yBAAO,IAAP;AACD,iBAFD,MAEO;AACL,yBAAO,KAAP;AACD;AACF,eAPD,CAOE,OAAOC,CAAP,EAAU;AACV,uBAAO,KAAP;AACD;AACF,aAZqB,EAarBC,GAbqB,CAajB;AAAA,qBAAKJ,EAAEK,EAAP;AAAA,aAbiB,CALH;AAoBfC,qBApBe,GAoBH,IAAIC,IAAJ,GAAWC,MAAX,EApBG;AAAA;AAAA,mBAsBf1B,cAAe,aAAf,EAA6B;AACjCK,qBADiC;AAEjCsB,uBAAU,aAFuB;AAGjCC,uCAAyB;AAHQ,aAA7B,CAtBe;;AAAA;;AA4BrB;AACA7B,kBACGe,QADH,GAEGe,KAFH,CAESb,MAFT,CAEgB;AAAA,qBAAK,CAACpB,EAAEkC,QAAF,CAAWf,eAAX,EAA4BG,EAAEa,eAA9B,CAAN;AAAA,aAFhB,EAGGf,MAHH,CAGU;AAAA,qBAAKE,EAAEc,SAAF,GAAcR,SAAnB;AAAA,aAHV,EAIGS,OAJH,CAIW,gBAAQ;AACf9B,2CAA6B,CAAC+B,KAAKC,IAAN,CAA7B;AACAjC,yBAAWgC,IAAX;AACD,aAPH;;AASApC,oBAAQsC,IAAR,CAAc,iBAAd;;AAtCqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAjB;;AAAA;AAAA;AAAA;AAAA,GAAN;;AAyCA,IAAMzB,uBAAuBf,EAAEyC,QAAF,CAAWzB,cAAX,EAA2B,GAA3B,CAA7B;;AAEA0B,OAAOC,OAAP,GAAiB,yBAAiB;AAChClC,YAAUmC,aAAV;AACD,CAFD","file":"page-hot-reloader.js","sourcesContent":["const _ = require(`lodash`)\n\nconst { emitter, store } = require(`../redux`)\nconst apiRunnerNode = require(`../utils/api-runner-node`)\nconst { boundActionCreators } = require(`../redux/actions`)\nconst { deletePage, deleteComponentsDependencies } = boundActionCreators\n\nlet pagesDirty = false\nlet graphql\n\nemitter.on(`CREATE_NODE`, action => {\n  if (action.payload.internal.type !== `SitePage`) {\n    pagesDirty = true\n  }\n})\nemitter.on(`DELETE_NODE`, action => {\n  pagesDirty = true\n  debouncedCreatePages()\n})\n\nemitter.on(`API_RUNNING_QUEUE_EMPTY`, () => {\n  if (pagesDirty) {\n    debouncedCreatePages()\n  }\n})\n\nconst runCreatePages = async () => {\n  pagesDirty = false\n  const plugins = store.getState().plugins\n  // Test which plugins implement createPagesStatefully so we can\n  // ignore their pages.\n  const statefulPlugins = plugins\n    .filter(p => {\n      try {\n        const gatsbyNode = require(`${p.resolve}/gatsby-node`)\n        if (gatsbyNode.createPagesStatefully) {\n          return true\n        } else {\n          return false\n        }\n      } catch (e) {\n        return false\n      }\n    })\n    .map(p => p.id)\n\n  const timestamp = new Date().toJSON()\n\n  await apiRunnerNode(`createPages`, {\n    graphql,\n    traceId: `createPages`,\n    waitForCascadingActions: true,\n  })\n\n  // Delete pages that weren't updated when running createPages.\n  store\n    .getState()\n    .pages.filter(p => !_.includes(statefulPlugins, p.pluginCreatorId))\n    .filter(p => p.updatedAt < timestamp)\n    .forEach(page => {\n      deleteComponentsDependencies([page.path])\n      deletePage(page)\n    })\n\n  emitter.emit(`CREATE_PAGE_END`)\n}\n\nconst debouncedCreatePages = _.debounce(runCreatePages, 100)\n\nmodule.exports = graphqlRunner => {\n  graphql = graphqlRunner\n}\n"]}